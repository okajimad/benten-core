　このドキュメントでは、弁天プロジェクトの主要な概念と用語を説明します。このオープンソースプロジェクトに参加したい人と、これを使って実際にカジノを運営したい人向けに書かれています。
　まず大事なのは、当プロジェクトではラスベガスやマカオにあるようなカジノの運営モデルを参考に設計されている、ということです。実際のカジノを知らない人はまずオンラインの検索でもいいのでカジノの仕組みを知ると弁天の理解の助けになるでしょう。

（挿絵）

# スマートコントラクト

弁天で使用するスマートコントラクトには次の４種類があります。

* Cashier
* Game
* Regulation
* Voting

まず基本となるCashierから説明していきます。

## Cashier

　本物のカジノと同様、Cashierは現金(Ethereum)とカジノ内で流通する**弁天コイン**との交換をつかさどります。ここでコインを導入するのは、Ethereumとコインの交換ルールにはさまざまなバリエーションが考えられるため、Cahierとそのコインを使って行うギャンブルと実装を分離する目的があります。
　コインはEthereum上のいわゆるトークンと似ていますが、コインのバリエーションの多様性を実現するための実装上の都合から、ERC20等の標準にはあえて従わず独自実装になっています。

　Cahierの中でももっとも基本的なものはEthereumとの等価交換を保証するものですが、それはさまざまなバリエーションの１つでしかなく、多くの形態が考えられます。実際にはカジノ設営者が自身の計画と好みによって決めることになります。
　また、**コインの発行元のCashierが異なれば、そのコイン間に互換性はありません**。カジノのチップが、カジノの運営会社ごとに固有であるのと同様の事情です。

<dl>

<dt>A. Ethereumとの交換に関する設定</dt>
<dd>
<ul>
<li> Ethereumと等価交換をスマートコントラクト内で強制するもの</li>
<li> Ethereumとの交換レートをCashier設営者の権利で決定するもの</li>
<li> Ethereumとの交換は参加者間の自由市場に任せるもの</li> 
</ul>
</dd>

<dt>B. Cashierで発行するコインの総量についての設定</dt>
<dd>
<ul>
<li> Cashier設営者がコインの追加発行権を持つもの</li>
<li> Cashier設営者であってもコインの追加発行権を持たず、Cashier開設時の上限以上にはコインが発行されないもの</li>
</ul>
</dd>

<dt>C. バックグラウンドとなるEthereumに何を用いるかの設定</dt>
<dd>
<ul>
<li> 本物のEthereumを用いるもの</li>
<li> Cashier自身が作成したプライベートEthrereumを用いるもの</li>
</ul>
</dd>
</dl>

　ABCはそれぞれ独立に選択可能なので、単純にいって３＊２＊２＝１２種類のCashierがあることになります。実装上はCashierのスマートコントラクトをデプロイする際の引数で決まってしまうものですが、参加者にとっては重要です。(a)でCashierが追加発行権を持つようにした場合、無節操に発行した場合にはコイン価値は０に近くなってしまうでしょうし、(3)の自由市場による価格決定としてもCashier設営者がある程度のマーケットメイキングをしなければうまく機能はしないでしょう。
　また、(β)のプライベートネット上のEtherereumを用いる場合、その独自Ethereumと他の仮想通貨または法定通貨との交換についてもCashier設営者が面倒を見てやる必要があります。

　なお、Cashier設営者は、**「実施するギャンブルが一定の条件を満たす限り」その開設時にはカジノ運営のための在庫のEthereumを持つ必要はありません**。これは、カジノ運営者は、チップを製造するのにチップの額面どおりの現金を用意する必要がないのと同じ理由です。その一定の条件については次節以降で説明します。

## Game
  Gameは、ギャンブルの１件ごと（今晩のサッカーの１試合、明日のS&P500終値、来月の選挙の結果、など）に対応して作られるコントラクトです。
　Gameにも運営責任者がいますが、Cashierの責任者と同じとは限りません。また、自由を重んじる観点から、Gameの設営にはCashierの承認を得る必要はありませんし、**仮にGame設営者に悪意があったとしてもCashierに損害を与えることはできない設計になっています**。

　Gameコントラクトは主に以下の機能が提供されます。

* どのCashierのコインを使ったギャンブルをしているか
* **誰が何にいくら賭けているか**の情報管理(ここがもっとも核心の情報です)
* ギャンブルの結果が確定した後、**適切な払戻金を計算し、各参加者にコインを戻す**処理

　Gameコントラクトもコインを所有者として各ユーザと同等の役割を持ちます。つまりCashierからみると、コインの所有者がユーザ自身であるかGameコントラクトであるかは特段の意味を持ちません。何かを賭けたり払い戻しをしたり、というのはCashier上のコインの移動にすぎず、その総量は変化しない、ということです。本物のカジノのバカラやブラックジャックにおいて、いくらゲームが進行してもチップを客とカジノの間で移動しているだけ、というのと一緒です。

| アクション     |コイン移動元 |コイン移動先|
|:-----------------|:-----------------|:-------------------|
| ユーザが賭ける|ユーザ |Game|
| 払い戻しを受ける|Game|ユーザ|

　しかし勘のよい読者は気づいているとおり、Gameに移動されたコインだけでは払戻金を賄いきれないケースがあります。Gameには２種類あり、

1. ユーザの供託金だけを原資に払い戻すギャンブル（例：賭けの締め切り後にオッズを決定するタイプのギャンブル、先物市場、など）
2. 払い戻し金総額がユーザの供託金を超える可能性のあるギャンブル（例：公営ギャンブルのかなりの割合）

があります。2.のタイプはよりドラマティックなギャンブルになりやすい一方、**大当たりが出た場合は不足のコインをGame運営者が手当しなければなりません**。手当の方法にも２通りあり、

* Game運営者が自身の資産でコインをCashierで購入してGameのコントラクトアドレスに送付することで払い戻し金に備える
* Cashierの承認のもと、CashierがGame設営者にコインを貸しつけ、後のギャンブルの利益から返済していく

　の２つを用意しています。このどちらのケースもCashierおよびGameのスマートコントラクトでサポートしています。
 前に、Game設営者はCashierの許可を取る必要はないと書きましたが、その条件で2.のタイプのギャンブルを実施するのは払い戻し金を賄いきれなくなる可能性があるため危険です。このタイプのギャンブルをするには、Game設営者はCashierの信用を得て、ユーザの掛け金上限を設定するなど節度ある運営をするのが賢明です。

 また、この点はCashierの損害を防いでいるというだけであり、Game自体の不正とは無関係ということに注意が必要です。悪意あるGameは、宝くじの当選番号をコントロールするかもしれません。それはユーザ自身が、ブロックチェーンにデプロイされたコントラクトのバイトコードを検証してGameを信用するかどうかを決める、というのが建前になります。

## Regulationコントラクト

　次にRegulationコントラクトを説明します。ちょっと退屈ですが、次節のセキュリティの話に繋がるのでここで説明しておきます。
　RegulationコントラクトはCashierごと、かつゲームの種類１件ごとに設定されるもので、「ギャンブルに関するルールを公開するために設定される」ものです。主に以下の内容からなります。

* 賭けの内容とsolidityのbyte配列とをマッピングするルール<br/>
  例えば、0～9の数３つを指定するタイプの宝くじでは、solidityのbytes8の下位３バイトに１つずつ指定する、というようなルールです。この内容はRegulationコントラクトの一部としてETHネット上にデプロイされるため後から改竄できません。
* 例外的事象（サッカーの試合で暴動が起きたために試合途中で中止になったときにどうするのか、等）の取り決めを自然言語で記述したドキュメントのURL
* そのドキュメントのハッシュ値

　この内容はGameの１つ１つに埋め込む方法もあるのですが、多くのギャンブルは同じルール下で多数のゲームが開催されるため、ルールの定義と執行にかかわる部分は共通化して１回だけデプロイしよう、というのがRegulationコントラクトの役割です。
　サッカー用のRegulationが１つあり、それを使って多数の試合への賭けが行われる、ということです。

　なお、**あらゆる賭け方がbyte arrayになる**というのは次節で重要になります。



## 賭けのエンコーディングとコイン移動のセキュリティ

　以前のDAO事件をみてもわかるとおり、スマートコントラクトはつねにセキュリティリスクにさらされています。弁天では、そのリスクを最小限に抑えるため、以下のデザインを採用しました。

* ユーザとGameはコインの所有者としてCashierから見た権限は同等である
* 従ってCashierの立場では、賭けとその払い戻しは、コインの移動処理にすぎない。
* コインの移動においては、コイン所有者からのリクエストしか受け付けないし、移動元が所有するコイン残高を超えた移動はできない。
* Gameコントラクトは、Cashierコントラクトへの参照を持ち（Gameコントラクトのデプロイ時のみに指定し事後的変更は不可）、賭けの受付はCashierコントラクトからしか受け付けない。

　前項で説明したとおり、あらゆる賭けはbyte array, そのち便宜的にbytes8とbytes16を使用します。賭けを行うためのSolidity上のメソッドは次の１つが唯一のルートで、bytes8バージョンの場合次のようになります。

    function bet8(address target, bytes8 content, uint coin) public {
        BettingTarget8 b = BettingTarget8(target);
        transferCoin(msg.sender, target, coin); //private method: modify internal storage
        // bet() accepts only if the caller is the Cashier associated the Game
        b.bet(msg.sender, content, coin);
    }

　BettingTarget.betは、msg.sender==cashierの場合にしか受け付けないようになっています。悪意ある第三者が勝手なGameコントラクトをデプロイしたとしても、そのコントラクトへのコイン移動はその悪者Gameコントラクトへのコイン送付を承認した者が、その人の所有するコイン残高の範囲内でしかできないため、Cashierが損害を受けることはない、というのが主要な設計ポイントです。

Memo: Gameの派生クラス等が偽装して他アカウントへTransferCoinしてしまうのを防ぐ必要があるが、そこまではCashierの責任ではない、で通す手もある

(挿絵)

## Votingコントラクト

　ギャンブルの結果を決定するのがVotingコントラクトです。これはGame運営者が恣意的に結果を決めることができない仕様になっている必要があります。もしそうでなければ、例えば公営宝くじのコピーにおいて事実と異なる当選番号を勝手に発表し、それに基づいてGame運営者が総取りになるような操作を防げません。
　それには２つの方法を考えています。

* 外部のOraclizeサービスを使うもの
* 参加者の多数決で決めるもの

　Oraclizeサービスを使うものについては特に説明は必要ないでしょうから、多数決制について説明します。この場合、まずGame運営者が自身で所有するコインから**一定の量をVoting FeeとしてをVotingコントラクトに供託**します。その上で、各Voterがそのギャンブルにおける正解（スポーツの試合結果、宝くじの当選番号など）をその**結果公表後**にコインを使用して投票します。その上で、

　「すべての投票コイン総数　＋　Game運営者が用意したVotingFee　」を、もっとも多い結果に投票した人で分配します。

　つまり、

* 一般のVoterにとっては、公表されている事実をVotingコントラクトへ入力するだけで、少額とはいえVotingFeeを原資としたリターンが見込める
* 多数派ではない結果へ投票した者は、それが否決された場合にその投票分は没収される
* 投票には締め切り時間が設けられているため、事実を捻じ曲げようとする者が正解以外に多くの投票をした場合、本来の正解に投票することのリターンが高まる

　ということです。

　仮に膨大な投票数でもって事実を捻じ曲げた結果を実現しようとしたとしても、ブロックチェーンの51%ルールと同様の困難があるということです。もちろん、Game運営者にも、大口かつ良心的なVoterとしてふるまって正解に大きな投票をする運営をすることでユーザの信用を獲得する動機があります。

　Voteするアカウントは賭けをしているかどうかとは関係ありません。

　また、周知の事実を入力するだけで報酬が貰えるというのは集客ツールとしても抜群の威力を発揮すると期待しています。

## コールドアドレス

　現状の弁天のWebアプリとAPIが揃ったあかつきには、確かにブラウザ上でギャンブルが可能になるのではあるが、Webで完結するがゆえに、見た目はふつうのオンラインギャンブルサイトと何ら変わるところはない。
　資金の出入りがETHなだけが唯一の違いになってしまう。

　そこでより「ブロックチェーンっぽい」運用を可能にしつつセキュリティも高めたものとしてコールドアドレス使用のアカウントを用意する。これは主に秘密鍵が専用ハードウェアで管理されたアドレスを使用することを想定しているという理由でコールドアドレスと名付けてるが、ユーザ自身が秘密鍵を管理するスタイルのものであれば何でもよい。
　コールドアドレスを使用するアカウントからのトランザクション発行が必要な場合次のように行う。

 * 弁天Web上で送りたい操作を指定する。
 * 署名前のトランザクションの生形式が画面に表示される。
 * それを自分のウォレットアプリにコピーして署名しトランザクション送出（おそらく送出機能はウォレットアプリにある）

　BIP32で導出されたホットウォレットはこの場合使わないが、両方を併用することも考えられるので、**Web画面上は両方の残高を区別して表示する必要がある**。
　Cashierから先のスマートコントラクトの方では、アドレスがコールドかホットかは全く区別しない。

　もちろんこれはオプショナルな機能であり、ホットウォレットだけで運用するアカウントは自分でのウォレット管理は不要である。


Memo:　投票締め切り時間間際に事実を捻じ曲げにくる攻撃をどのように防ぐか。Game設営者の資力でねじ伏せるしかなさそうだが...